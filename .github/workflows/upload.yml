name: آپلود گالری به Arweave

on:
  repository_dispatch:
    types: [upload_gallery]

jobs:
  encrypt-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: نصب Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: نصب Arweave
        run: npm install arweave crypto-js

      - name: اسکریپت انکریپت و آپلود
        env:
          ARWEAVE_KEY: ${{ secrets.ARWEAVE_KEY }}   # کیف‌پول من که AR داره
        run: |
          node - <<'EOF'
          const Arweave = require('arweave');
          const CryptoJS = require('crypto-js');
          const fs = require('fs');

          const arweave = Arweave.init({host: 'arweave.net', port: 443, protocol: 'https'});
          const key = JSON.parse(process.env.ARWEAVE_KEY);

          // اینجا بعداً فایل‌ها از payload میان (برای تست ساده یه HTML می‌سازیم)
          const password = "1234";
          const html = `<!DOCTYPE html><html><body><h1>تست موفق! رمز: ${password}</h1></body></html>`;
          const encrypted = CryptoJS.AES.encrypt(html, password).toString();

          (async () => {
            const tx = await arweave.createTransaction({data: encrypted}, key);
            tx.addTag('App', 'CryptoArt-Test');
            await arweave.transactions.sign(tx, key);
            await arweave.transactions.post(tx);
            console.log("لینک انکریپت‌شده: https://arweave.net/" + tx.id);
            console.log("لینک دیکریپتر: https://ahmadjavan.ir/decryptor.html?tx=" + tx.id);
          })();
          EOF
