name: آپلود و انکریپت به Arweave

on:
  workflow_dispatch:

jobs:
  test-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install packages
        run: npm init -y && npm install arweave crypto-js

      - name: Run upload
        env:
          WALLET: ${{ secrets.ARWEAVE_WALLET }}
        run: |
          node - << 'EOF'
          const Arweave = require('arweave');
          const CryptoJS = require('crypto-js');

          const arweave = Arweave.init({ host: 'arweave.net', port: 443, protocol: 'https' });
          const wallet = JSON.parse(process.env.WALLET);

          const html = `<!DOCTYPE html><html dir="rtl"><body style="background:#000;color:#0ff;text-align:center;padding:100px;font-family:Tahoma;font-size:40px;"><h1>تست موفق احمدجوان!</h1><p>رمز برای باز کردن: 1234</p></body></html>`;

          const encrypted = CryptoJS.AES.encrypt(html, "1234").toString();

          (async () => {
            const tx = await arweave.createTransaction({ data: encrypted }, wallet);
            await arweave.transactions.sign(tx, wallet);
            const result = await arweave.transactions.post(tx);
            if (result.status === 200) {
              console.log("لینک گالری انکریپت‌شده:");
              console.log("https://arweave.net/" + tx.id);
              console.log("لینک دیکریپتر:");
              console.log("https://ahmadjavan.ir/decryptor.html?tx=" + tx.id);
            } else {
              console.log("خطا در آپلود");
            }
          })();
          EOF
